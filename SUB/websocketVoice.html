<!DOCTYPE HTML>
<html>

<head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <title>Sockettester</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js" type="text/javascript" charset="utf-8"></script>
    <script type="text/javascript" charset="utf-8">
        var ws = null;
        var host = "localhost"
        var port = 8000
        var socket = "p5websocket"
        var recognition = new webkitSpeechRecognition();

        // Be default, Chrome will only return a single result.
        // By enabling "continuous", Chrome will keep the microphone active.
        recognition.continuous = true;
        recognition.onresult = function(event) {
            // Get the current result from the results object
            var transcript = event.results[event.results.length - 1][0].transcript;
            console.log(transcript);
            // Send the result string via WebSocket to the running Processing Sketch
            ws.send(transcript);
        }

        function ready() {
            console.log("trying to open a websocket")
            var _socket = (undefined == socket) ? "" : "/" + socket

            _url = "ws://" + host + ":" + port + _socket

            if ('MozWebSocket' in window) ws = new MozWebSocket(_url);
            else ws = new WebSocket(_url);

            // When the connection is open, send some data to the server
            ws.onopen = function() {
                console.log("opened")
                ws.send('Ping'); // Send the message 'Ping' to the server
                // Start the recognition
                recognition.start();
            };
            // oh, it did close
            ws.onerror = function(e) {
                console.log('WebSocket did close ', e);
            };

            // Log errors
            ws.onerror = function(error) {
                console.log('WebSocket Error ' + error);
            };
            // Log messages from the server
            ws.onmessage = function(e) {
                $('#log').text(e.data + $('#log').text())
                console.log('Server: ' + e.data);
            };
        }

        document.addEventListener("DOMContentLoaded", ready, false);

        window.setInterval(function() {
            location.reload();
            //reload every minute
        }, 60000);
        //
    </script>
</head>

<body>
    <div id="test-target">

    </div>
    <div id="log">

    </div>
</body>

</html>
